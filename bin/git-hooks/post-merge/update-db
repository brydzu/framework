#!/usr/bin/php
<?php

return;

if ($argc < 1 ) {
   echo "USAGE: {$argv[0]} <commit-ish> [<commit-ish>]\n";
   exit(1);
}

// General setup
define('BASE_PATH', trim(`git rev-parse --show-toplevel`));

set_include_path(get_include_path() . PATH_SEPARATOR . BASE_PATH . '/lib' . PATH_SEPARATOR);

$loader = require_once(BASE_PATH . "/vendor/autoload.php");
$loader->setUseIncludePath(true);

chdir(BASE_PATH);


// Find added SQL scripts and execute them
$prev_commit = $argv[1];
$post_commit = isset($argv[2]) ? $argv[2] : "HEAD";

$cfg = App::config()->db;
$mysql = "mysql -h " . escapeshellarg($cfg->host) . " -u " . escapeshellarg($cfg->username) . " -p" . escapeshellarg($cfg->password) . " " . escapeshellarg($cfg->dbname);

$files = explode("\n", trim(`git log -c --no-merges --pretty="format:" --name-status "$prev_commit".."$post_commit" -p "dev/db/update" | awk '{ if (\$1 == "A") { print \$2 }}'`));

foreach ($files as $file) {
    echo "\n", "\033[1;32m", "Executing `", basename($file), "`", "\033[0m", "\n";
    passthru("$mysql < $file");
}
